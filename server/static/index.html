<!DOCTYPE html>


<html lang="en">
  <head>
    <title>Chat Example</title>
    <script type="text/javascript">
      window.onload = function () {
        var conn;
        var canvas = document.createElement("canvas");
        canvas.width = 1000;
        canvas.height = 750;
        document.body.appendChild(canvas);
        var ctx = canvas.getContext("2d");

        // Paddle 1
        var paddle1 = {
          x: 37.5,
          y: canvas.height / 2 - 50,
          vx: 0,
          vy: 0,
          width: 25,
          height: 100,
          color: "white",
        };

        // Paddle 2
        var paddle2 = {
          x: 962.5 - 25,
          y: canvas.height / 2 - 50,
          vx: 0,
          vy: 0,
          width: 25,
          height: 100,
          color: "white",
        };

        // Ball
        var ball = {
          x: canvas.width / 2,
          y: canvas.height / 2,
          radius: 10,
          vx: 0,
          vy: 0,
          color: "white",
        };

        function drawPaddle(paddle) {
          ctx.fillStyle = paddle.color;
          ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
        }

        function drawBall() {
          ctx.beginPath();
          ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
          ctx.fillStyle = ball.color;
          ctx.fill();
          ctx.closePath();
        }

        function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawPaddle(paddle1);
          drawPaddle(paddle2);
          drawBall();
        }

        setInterval(draw, 10);
        document.addEventListener("keyup", function(event) {
          if (event.key === "w") {
            if (conn) {
              conn.send('{"type" : "input", "input" : "up", "status" : "released"}');
            }
          }          
          if (event.key === "s") {
            if (conn) {
              conn.send('{"type" : "input", "input" : "down", "status" : "released"}');
            }
          }
        });
        document.addEventListener("keydown", function(event) {
          if (event.key === "w") {
            if (conn) {
              conn.send('{"type" : "input", "input" : "up", "status" : "down"}');
            }
          }
          if (event.key === "s") {
            if (conn) {
              conn.send('{"type" : "input", "input" : "down", "status" : "down"}');
            }
          }
        });

        if (window["WebSocket"]) {
          conn = new WebSocket("ws://" + document.location.host + "/upgrade");
          conn.onclose = function (evt) {
          };
          conn.onmessage = function (evt) {
            var messages = evt.data.split("\n");
            for (var i = 0; i < messages.length; i++) {
              var item = document.createElement("div");
              item.innerText = messages[i];
              var message = JSON.parse(messages[i]);
              if (message["type"] == "gamestate") {
                console.log(message);
                ball.x = message.game.Ball.x;
                ball.y = message.game.Ball.y;
                paddle1.y = message.game.PlayerA.y
                paddle2.y = message.game.PlayerB.y
              }
            }
          };

          conn.onping = function (evt) {
            // Handle WebSocket ping
            console.log("Received ping from server");
            conn.pong();
          };

          conn.onpong = function (evt) {
            // Handle WebSocket pong
            console.log("Received pong from server");
          };

          setInterval(function() {
            if (conn) {
              conn.send(10)
            }
          }, 10000);
        } else {
          var item = document.createElement("div");
          item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
          setState(item);
        }
      };
    </script>
    <style type="text/css">
      html {
        overflow: hidden;
      }

      body {
        overflow: hidden;
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        background: gray;
      }

      #log {
        background: white;
        margin: 0;
        padding: 0.5em 0.5em 0.5em 0.5em;
        position: absolute;
        top: 0.5em;
        left: 0.5em;
        right: 0.5em;
        bottom: 3em;
        overflow: auto;
      }

      #form {
        padding: 0 0.5em 0 0.5em;
        margin: 0;
        position: absolute;
        bottom: 1em;
        left: 0px;
        width: 100%;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
  </body>
</html>
